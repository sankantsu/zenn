---
title: "glibc ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ã¿ã‚ˆã†"
emoji: "ğŸ¦¬"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["C", "libc", "glibc"]
published: true
---

## TL;DR

```sh
# ã‚½ãƒ¼ã‚¹ã®å…¥æ‰‹
wget https://ftp.gnu.org/gnu/glibc/glibc-2.39.tar.gz
tar zxf glibc-2.39.tar.gz

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æº–å‚™
mkdir glibc-build glibc-install  # ãƒ“ãƒ«ãƒ‰, ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç”¨ã«ã‚½ãƒ¼ã‚¹ã¨åˆ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå¿…è¦
cd glibc-build

# ãƒ“ãƒ«ãƒ‰ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
../glibc-2.39/configure --prefix=`realpath ../glibc-install` CFLAGS="-O2 -D_FORTIFY_SOURCE=2"  # ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã®å›é¿ã®ãŸã‚ CFLAGS ã®æŒ‡å®šãŒå¿…è¦
make -j
make install

# å‹•ä½œç¢ºèª
LD_PRELOAD=`realpath ../glibc-install/lib/libc.so.6` <your-app>
```

## æ¦‚è¦

glibc ã¯ã€C æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª libc ã®ãƒ¡ã‚¸ãƒ£ãƒ¼ãªå®Ÿè£…ã§ã™ã€‚
libc ã¯ C è¨€èªã‚’ç›´æ¥ä½¿ã‚ãªã„å ´åˆã§ã‚‚é–“æ¥çš„ã«åˆ©ç”¨ã—ã¦ã„ã‚‹ã“ã¨ãŒå¤šãã‚ã‚Šã€å˜ã« C è¨€èªç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã„ã†ã ã‘ã§ãªã Linux ã‚·ã‚¹ãƒ†ãƒ ã®åŸºç›¤ã¨ã—ã¦ã‚‚é‡è¦ã¨ã„ãˆã‚‹ã‚‚ã®ã§ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¯ glibc ã‚’è‡ªåˆ†ã§ãƒ“ãƒ«ãƒ‰ã—ã¦åˆ©ç”¨ã—ã¦ã¿ã¾ã™ã€‚
ã¾ãŸã€ãŠã¾ã‘ã¨ã—ã¦ glibc ã«ç°¡å˜ãªå¤‰æ›´ã‚’åŠ ãˆã¦å‹•ä½œç¢ºèªã™ã‚‹ã¨ã“ã‚ã¾ã§è¡Œã£ã¦ã¿ã¾ã™ã€‚

å®Ÿéš›ã«ãƒ“ãƒ«ãƒ‰ã‚’è©¦ã—ãŸéš›ã€å…¬å¼ã® README ã‚„ INSTALL ã®ã‚¬ã‚¤ãƒ‰ã ã‘ã§ã¯è§£æ±ºã—ã¥ã‚‰ã„ãƒãƒã‚Šã©ã“ã‚ãŒã‚ã£ãŸã®ã§åŒã˜ã‚ˆã†ãªã“ã¨ã‚’è©¦ã—ãŸã„æ–¹ã«å‘ã‘ã¦å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

## ç›®çš„

ã“ã®è¨˜äº‹ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªç›®çš„ã‚’æƒ³å®šã—ã¦æ›¸ã„ã¦ã„ã¾ã™ã€‚

- ã‚·ã‚¹ãƒ†ãƒ ã® libc ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤ã„ãªã©ã®ç†ç”±ã§è‡ªåˆ†ã§ãƒ“ãƒ«ãƒ‰ã—ãŸã‚‚ã®ã‚’ä½¿ã„ãŸã„^[ã“ã®ç”¨é€”ã§ã‚ã‚Œã°åŸºæœ¬çš„ã«ã¯å¯èƒ½ã§ã‚ã‚Œã° Docker ã‚„ VM ã®åˆ©ç”¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™]ã€‚
- å­¦ç¿’ç”¨é€”ã§ glibc ã‚’å¤‰æ›´ã—ã¦åˆ©ç”¨ã—ã¦ã¿ãŸã„ã€‚

## ç’°å¢ƒ

glibc ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦åˆ©ç”¨ã™ã‚‹ã«ã¯ã€åŸºæœ¬çš„ã« Linux ç’°å¢ƒãŒå¿…è¦ã§ã™ã€‚
Mac ã‚’åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹æ–¹å‘ã‘ã«ã¯ç’°å¢ƒã‚’ç”¨æ„ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦[è£œè¶³](#mac-åˆ©ç”¨è€…å‘ã‘ã®ç’°å¢ƒæ§‹ç¯‰æ‰‹é †)ã‚’æ›¸ã„ãŸã®ã§é©å®œã”å‚ç…§ãã ã•ã„ã€‚

ä»Šå›ã¯ aarch64 Ubuntu 24.04 ç’°å¢ƒ (VM) ã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€‚
ãƒ“ãƒ«ãƒ‰ç”¨ã« `gcc` ç­‰ã„ãã¤ã‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’ç”¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ ([å‚è€ƒ](https://sourceware.org/glibc/wiki/FAQ#What_tools_do_I_need_to_build_GNU_libc.3F))ã€‚
`sudo apt install build-essential bison` ç­‰ã§äº‹å‰ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚
ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç­‰ã¯ä»¥ä¸‹ã®æŠ˜ã‚Šç•³ã¿å†…ã«ç¤ºã—ã¦ãŠãã¾ã™ã€‚

:::details ç’°å¢ƒã®è©³ç´°

```sh
ubuntu@primary:~$ uname -a
Linux primary 6.8.0-41-generic #41-Ubuntu SMP PREEMPT_DYNAMIC Fri Aug  2 23:26:06 UTC 2024 aarch64 aarch64 aarch64
GNU/Linux

ubuntu@primary:~$ cat /etc/os-release
PRETTY_NAME="Ubuntu 24.04 LTS"
NAME="Ubuntu"
VERSION_ID="24.04"
VERSION="24.04 LTS (Noble Numbat)"
VERSION_CODENAME=noble
ID=ubuntu
ID_LIKE=debian
HOME_URL="https://www.ubuntu.com/"
SUPPORT_URL="https://help.ubuntu.com/"
BUG_REPORT_URL="https://bugs.launchpad.net/ubuntu/"
PRIVACY_POLICY_URL="https://www.ubuntu.com/legal/terms-and-policies/privacy-policy"
UBUNTU_CODENAME=noble
LOGO=ubuntu-logo

ubuntu@primary:~$ gcc --version
gcc (Ubuntu 13.2.0-23ubuntu4) 13.2.0
Copyright (C) 2023 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

ubuntu@primary:~$ ldd --version
ldd (Ubuntu GLIBC 2.39-0ubuntu8.3) 2.39
Copyright (C) 2024 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
Written by Roland McGrath and Ulrich Drepper.

ubuntu@primary:~$ ld --version
GNU ld (GNU Binutils for Ubuntu) 2.42
Copyright (C) 2024 Free Software Foundation, Inc.
This program is free software; you may redistribute it under the terms of
the GNU General Public License version 3 or (at your option) a later version.
This program has absolutely no warranty.
```

:::

## ã‚½ãƒ¼ã‚¹ã®å…¥æ‰‹

glibc ã®ã‚½ãƒ¼ã‚¹ã¯ [GNU ã®å…¬å¼ãƒªãƒªãƒ¼ã‚¹](https://ftp.gnu.org/gnu/glibc/) ã‹ã‚‰å…¥æ‰‹ã§ãã¾ã™ã€‚

```sh
$ wget https://ftp.gnu.org/gnu/glibc/glibc-2.39.tar.gz
$ tar zxf glibc-2.39.tar.gz
```

ã¾ãŸã€glibc ã®ã‚½ãƒ¼ã‚¹ã¯ Ubuntu packages ç­‰ã§ã‚‚é…å¸ƒã•ã‚Œã¦ã„ã¾ã™ ([glibc-source (2.39-0ubuntu8.3)](https://packages.ubuntu.com/noble/glibc-source))ã€‚
ç¢ºå®Ÿã«ãƒ›ã‚¹ãƒˆã® Linux ç’°å¢ƒã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’åˆã‚ã›ãŸã„å ´åˆãªã©ã¯ã“ã¡ã‚‰ã‚’åˆ©ç”¨ã—ãŸã»ã†ãŒè‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

## ãƒ“ãƒ«ãƒ‰

åŸºæœ¬çš„ãªæµã‚Œã¨ã—ã¦ã¯ä¼çµ±çš„ãª `configure`, `make`, `make install` ã® 3 ã‚¹ãƒ†ãƒƒãƒ—ã§ã™ã€‚
ä»¥ä¸‹ã§è©³ã—ã„æ‰‹é †ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æº–å‚™

ãƒ“ãƒ«ãƒ‰ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯ã‚½ãƒ¼ã‚¹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨åˆ†ã‘ã¦è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã‚½ãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã§ç›´æ¥ `./configure` ã‚’å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

```
configure: error: you must configure in a separate build directory
```

ã¾ãŸã€`--prefix` ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã—ãªã„ã¨è­¦å‘ŠãŒå‡ºã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã® libc ã‚’èª¤ã£ã¦ç½®ãã‹ãˆã¦ã—ã¾ã£ãŸã‚Šã™ã‚‹ã¨å¾©æ—§ãŒå¤§å¤‰ã«ãªã‚‹ãŸã‚ã§ã™ã€‚

:::details è­¦å‘Šã®å†…å®¹

```
*** On GNU/Linux systems the GNU C Library should not be installed into
*** /usr/local since this might make your system totally unusable.
*** We strongly advise to use a different prefix.  For details read the FAQ.
*** If you really mean to do this, run configure again using the extra
*** parameter `--disable-sanity-checks'.
```

:::

ä»Šå›ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã‚’æ¡ç”¨ã—ã¾ã™ã€‚

```
.
â”œâ”€â”€ glibc-2.39  # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
â”œâ”€â”€ glibc-build  # ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
â””â”€â”€ glibc-install  # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
```

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ç”¨æ„ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

```sh
$ mkdir glibc-build glibc-install  # ãƒ“ãƒ«ãƒ‰, ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç”¨ã«ã‚½ãƒ¼ã‚¹ã¨åˆ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå¿…è¦
$ cd glibc-build
```

### ãƒ“ãƒ«ãƒ‰ã®å®Ÿè¡Œ

ãƒ“ãƒ«ãƒ‰ã®éš›ã¯ã€ç‰¹ã« `configure` ã®éš›ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

```sh
$ ../glibc-2.39/configure --prefix=`realpath ../glibc-install` CFLAGS="-O2 -D_FORTIFY_SOURCE=2"
$ make -j
$ make install
```

æ­£ã—ãã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚Œã°ã€`glibc-install/` ä»¥ä¸‹ã®ã‚ˆã†ã«ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹é€ ã§ libc ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚

```
.
â”œâ”€â”€ bin
â”‚Â Â  â”œâ”€â”€ ld.so -> ../lib/ld-linux-aarch64.so.1
â”‚Â Â  â”œâ”€â”€ ldd
â”‚Â Â  â””â”€â”€ (ç•¥)
â”œâ”€â”€ etc
â”‚Â Â  â”œâ”€â”€ ld.so.cache
â”‚Â Â  â””â”€â”€ rpc
â”œâ”€â”€ include
â”‚Â Â  â”œâ”€â”€ stdio.h
â”‚Â Â  â”œâ”€â”€ stdlib.h
â”‚Â Â  â””â”€â”€ (ç•¥)
â”œâ”€â”€ lib
â”‚Â Â  â”œâ”€â”€ ld-linux-aarch64.so.1
â”‚Â Â  â”œâ”€â”€ libc.so.6
â”‚Â Â  â””â”€â”€ (ç•¥)
â”œâ”€â”€ sbin
â”œâ”€â”€ share
â”œâ”€â”€ tmp
â””â”€â”€ var
```


### ãƒ“ãƒ«ãƒ‰ã®å¤±æ•—ä¾‹

(è©¦è¡Œéç¨‹ã«èˆˆå‘³ãŒç„¡ã‘ã‚Œã°[æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³]()ã¾ã§é£›ã°ã—ã¦ãã ã•ã„)

`configure` ã§ `CFLAGS` ã‚’å…¨ãæŒ‡å®šã›ãšã« `make` ã‚’å®Ÿè¡Œã—ãŸå ´åˆã€ç§ã®ç’°å¢ƒã§ã¯ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ã§ãƒ“ãƒ«ãƒ‰ãŒæ­¢ã¾ã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚

```sh
$ ../glibc-2.39/configure --prefix=`realpath ../glibc-install`
$ make -j
wctomb.c:57:1: error: â€˜artificialâ€™ attribute ignored [-Werror=attributes]
   57 | libc_hidden_def (wctomb)
      | ^~~~~~~~~~~~~~~
cc1: all warnings being treated as errors
```

ã“ã® attribute ã®ã‚¨ãƒ©ãƒ¼ã ã‘ã«é–¢ã—ã¦è¨€ãˆã° `--disable-werror` ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§å›é¿ã§ãã‚‹ã®ã§ã™ãŒã€ä»Šåº¦ã¯åˆ¥ã®ã¨ã“ã‚ã§æ­¢ã¾ã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚

```sh
$ ../glibc-2.39/configure --prefix=`realpath ../glibc-install` --disable-werror
$ make -j
In file included from <command-line>:
syslog.c: In function â€˜__vsyslog_internalâ€™:
syslog.c:95:30: error: inlining failed in call to â€˜always_inlineâ€™ â€˜syslogâ€™: function not inlinable
   95 | ldbl_strong_alias (__syslog, syslog)
      |                              ^~~~~~
./../include/libc-symbols.h:143:26: note: in definition of macro â€˜_strong_aliasâ€™
  143 |   extern __typeof (name) aliasname __attribute__ ((alias (#name))) \
      |                          ^~~~~~~~~
../sysdeps/generic/math_ldbl_opt.h:14:44: note: in expansion of macro â€˜strong_aliasâ€™
   14 | #define ldbl_strong_alias(name, aliasname) strong_alias (name, aliasname)
      |                                            ^~~~~~~~~~~~
syslog.c:95:1: note: in expansion of macro â€˜ldbl_strong_aliasâ€™
   95 | ldbl_strong_alias (__syslog, syslog)
      | ^~~~~~~~~~~~~~~~~
syslog.c:138:7: note: called from here
  138 |       syslog (INTERNALLOG, "syslog: unknown facility/priority: %x", pri);
      |       ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

ãƒ‘ãƒƒã¨è¦‹ã§ã¯è§£æ±ºç­–ãŒã‚ˆãã‚ã‹ã‚‰ãªã‹ã£ãŸã®ã§ã™ãŒã€èª¿ã¹ãŸã¨ã“ã‚ä»¥ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã« `_FORTIFY_SOURCE=2` ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã§ãã¾ã—ãŸã€‚

- https://www.reddit.com/r/archlinux/comments/o3fqy4/problem_with_building_glibc/
- https://stackoverflow.com/questions/11852123/glibc-error-while-building-linux-from-scratch

`_FORTIFY_SOURCE` ã«ã¤ã„ã¦ã¯ã€[man feature_test_macros](https://man7.org/linux/man-pages/man7/feature_test_macros.7.html) ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã™ã€‚æ­£ç›´ãªã¨ã“ã‚è©³ç´°ã¯ç­†è€…ãŒã‚ˆãã‚ã‹ã£ã¦ã„ãªã„ã®ã§ã™ãŒã€ãƒãƒƒãƒ•ã‚¡ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ç­‰ã®ãƒã‚§ãƒƒã‚¯ã®ç¨‹åº¦ã«ã¤ã„ã¦ã®æŒ‡å®šã§ã‚ã‚‹ã‚ˆã†ã§ã™ã€‚

## å‹•ä½œç¢ºèª

è‡ªåˆ†ã§ãƒ“ãƒ«ãƒ‰ã—ãŸ glibc ã‚’ç”¨ã„ã‚‹ä¸Šã§æœ€ã‚‚æ‰‹è»½ãªã‚„ã‚Šæ–¹ã¯ã€`LD_PRELOAD` ã‚„ `LD_LIBRARY_PATH` ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ã£ã¦å®Ÿè¡Œæ™‚ã«æŒ‡å®šã—ãŸå…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹æ–¹æ³•ã§ã™ã€‚

ç°¡å˜ãª Hello world ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ç”¨æ„ã—ã¦ãŠãã¾ã™ã€‚

```c
// hello.c
#include <stdio.h>

int main() {
        printf("Hello, World!\n");
}
```

```sh
$ gcc hello.c  # å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ« a.out ã‚’æº–å‚™
```

`LD_PRELOAD` ã¾ãŸã¯ `LD_LIBRARY_PATH` ã‚’ç”¨ã„ã¦è‡ªåˆ†ã§ãƒ“ãƒ«ãƒ‰ã—ãŸ libc ã‚’ãƒ­ãƒ¼ãƒ‰ã•ã›ã‚‹ã‚ˆã†ã«ã—ã¦å®Ÿè¡Œã—ã¾ã™ã€‚

```sh
$ LD_PRELOAD=glibc-install/lib/libc.so.6 ./a.out
Hello, World!

$ LD_LIBRARY_PATH=glibc-install/lib/ ./a.out
Hello, World!
```

è‡ªåˆ†ã§ãƒ“ãƒ«ãƒ‰ã—ãŸ libc ã‚’ç”¨ã„ã¦ã‚‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒæ­£å¸¸ã«å®Ÿè¡Œã§ãã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

### å¤‰æ›´ã‚’åŠ ãˆã¦å‹•ã‹ã™

æœ€å¾Œã«ãŠã¾ã‘ã¨ã—ã¦ã€glibc ã®ã‚½ãƒ¼ã‚¹ã«ç°¡å˜ãªå¤‰æ›´ã‚’åŠ ãˆã¦å‹•ã‹ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
æ–‡å­—åˆ—ã‚’æ¨™æº–å‡ºåŠ›ã«æ›¸ãã ã™ `puts()` é–¢æ•°ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¦ã€`You called puts!` ã¨ã„ã†æ–‡å­—åˆ—ãŒè¿½åŠ ã§å‡ºåŠ›ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã™ã€‚

```c
int
_IO_puts (const char *str)
{
  int result = EOF;
  size_t len = strlen (str);
  _IO_acquire_lock (stdout);

  if ((_IO_vtable_offset (stdout) != 0
       || _IO_fwide (stdout, -1) == -1)
      && _IO_sputn (stdout, "You called puts!\n", 17) == 17  // added this line!
      && _IO_sputn (stdout, str, len) == len
      && _IO_putc_unlocked ('\n', stdout) != EOF)
    result = MIN (INT_MAX, len + 1);

  _IO_release_lock (stdout);
  return result;
}
```

glibc ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ãŸä¸Šã§ã€`make` ãŠã‚ˆã³ `make install` ã‚’å®Ÿè¡Œã—ç›´ã—ã¦ãã ã•ã„ã€‚
æœ€å¾Œã«ã€Hello world ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å†åº¦å¤‰æ›´å¾Œã® glibc ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚ˆã†ã«ã—ã¦å®Ÿè¡Œã—ã¾ã™ã€‚

```sh
$ LD_PRELOAD="glibc-install/lib/libc.so.6" ./a.out
You called puts!
Hello, World!
```

`puts()` ã¸ã®å¤‰æ›´ãŒåæ˜ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã—ãŸ^[`hello.c` ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ä¸­ã§ã¯ `printf()` ã‚’å‘¼ã‚“ã§ã„ã¾ã™ãŒã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæŒ‡å®šã®ãªã„ `printf()` ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æœ€é©åŒ–ã«ã‚ˆã£ã¦ `puts()` ã«ç½®ãã‹ãˆã‚‰ã‚Œã¦ã„ã¾ã™]ã€‚

## ãŠã‚ã‚Šã«

ä»Šå›ã¯ glibc ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹æ–¹æ³•ãŠã‚ˆã³ãƒ“ãƒ«ãƒ‰ã—ãŸ glibc ã‚’ç”¨ã„ã¦ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å‹•ã‹ã™æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã—ãŸã€‚
ãªã‹ãªã‹ libc ã‚’ã„ã˜ã‚‰ãªã‘ã‚Œã°ãªã‚‰ãªã„æ©Ÿä¼šã¨ã„ã†ã®ã¯å¤šããªã„ã¨æ€ã„ã¾ã™ãŒã€æ™®æ®µæ°—ã¥ã‹ãšã« libc ã®æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã„ã‚‹ã“ã¨ã¯ãŸãã•ã‚“ã‚ã‚‹ã®ã§ã€ã‚½ãƒ¼ã‚¹ã‚’èª­ã‚“ã ã‚Šã—ã¦ã¿ã‚‹ã¨ã„ã‚ã„ã‚ã¨ç™ºè¦‹ãŒã‚ã‚Šé¢ç™½ã„ã§ã™ã€‚
ã“ã®è¨˜äº‹ãŒ libc ã‚’ã„ã˜ã£ã¦ã¿ã‚‹ãã£ã‹ã‘ã«ãªã£ãŸã‚Šã™ã‚Œã°å¹¸ã„ã§ã™ã€‚

æœ€å¾Œã¾ã§èª­ã‚“ã§ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼

## å‚è€ƒ

- [The GNU C Library](https://www.gnu.org/software/libc/)
- æ›¸ç±: Binary Hacks Rebooted ([O'Reilly Japan](https://www.oreilly.co.jp/books/9784814400850/)) #15 glibcã‚’Hackã™ã‚‹

## è£œè¶³

### Mac åˆ©ç”¨è€…å‘ã‘ã®ç’°å¢ƒæ§‹ç¯‰æ‰‹é †

glibc ã¯ MacOS ä¸Šã§ã¯ç›´æ¥ãƒ“ãƒ«ãƒ‰ã§ãã¾ã›ã‚“ã€‚
`configure` å®Ÿè¡Œæ™‚ã«ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

```
configure: error:
*** The GNU C library is currently unavailable for this platform.
*** If you are interested in seeing glibc on this platform visit
*** the "How to submit a new port" in the wiki:
***   https://sourceware.org/glibc/wiki/#Development
*** and join the community!
```

ç­†è€…è‡ªèº«ã‚‚ Mac ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ãŒã€ä»Šå›ã¯ [multipass](https://github.com/canonical/multipass) ã‚’åˆ©ç”¨ã—ã¦æ§‹ç¯‰ã—ãŸ Linux VM ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ (ãŠãã‚‰ã Docker ç­‰åˆ©ç”¨ã™ã‚‹æ–¹æ³•ã§ã‚‚å•é¡Œç„¡ã„ã§ã—ã‚‡ã†)ã€‚
multipass ã«ã‚ˆã‚‹ Ubuntu VM ç’°å¢ƒã®ä½œæˆã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ‰‹é †ã§è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

```sh
$ brew install --cask multipass
$ multipass launch
$ multipass shell
```

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è³‡æºé…åˆ†ã§ã‚‚å®Ÿè¡Œã¯ã§ãã¾ã™ãŒå°‘ã—å¿ƒè¨±ãªã„ã§ã™ã€‚å¤‰æ›´ã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã§ãã¾ã™ã€‚

```sh
$ multipass set local.primary.cpus=4
$ multipass set local.primary.memory=8.0GiB
$ multipass set local.primary.disk=32.0GiB
```

è©³ã—ãã¯å…¬å¼ã® [README](https://github.com/canonical/multipass) ç­‰ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
